<!-- src/main/resources/templates/payment.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>결제 페이지</title>
</head>
<body>
<h1>결제하기</h1>

<p>주문번호: <strong th:text="${orderId}"></strong></p>
<p>결제 금액: <strong th:text="${totalPrice}"></strong>원</p>

<form th:action="@{/api/v1/payments/toss/{oid}(oid=${orderId})}"
      method="post"
      th:object="${#beans.emptyBean}"
      enctype="application/json">
    <!-- 실제로는 AJAX로 JSON 바디를 보내는 편이 깔끔합니다만,
         간단히 hidden 필드 + JS fetch 예시를 드립니다. -->

    <input type="hidden" id="orderId" th:value="${orderId}" />
    <input type="hidden" id="payAmount" th:value="${totalPrice}" />

    <label>
        주문명:
        <input type="text" id="payName" placeholder="주문명을 입력하세요" required />
    </label>
    <br/>

    <label>
        결제수단:
        <select id="payType">
            <option value="CARD">신용카드</option>
            <option value="ACCOUNT">가상계좌</option>
        </select>
    </label>
    <br/>

    <button type="button" onclick="submitPayment()">결제 요청</button>
</form>

<script th:inline="javascript">
    /*<![CDATA[*/
    async function submitPayment() {
        const oid  = /*[[${orderId}]]*/ '';
        const body = {
            payAmount: document.getElementById('payAmount').value,
            payName:   document.getElementById('payName').value,
            payType:   document.getElementById('payType').value
        };

        const resp = await fetch(`/api/v1/payments/toss/${oid}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (!resp.ok) {
            const err = await resp.json();
            alert('결제 요청 실패: ' + err.message);
            return;
        }

        const data = await resp.json();
        // Toss가 준 redirectUrl로 리다이렉트
        window.location.href = data.redirectUrl;
    }
    /*]]>*/
</script>
</body>
</html>