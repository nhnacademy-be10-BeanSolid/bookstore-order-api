<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>주문 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5" th:object="${orderForm}">
  <h1 class="mb-4">전체 주문 목록</h1>

  <!-- 전체 주문 테이블 -->
  <div class="table-responsive">
    <table class="table table-striped">
      <thead class="table-dark">
      <tr>
        <th>주문 ID</th>
        <th>주문 유형</th>
        <th>총 상품 금액</th>
        <th>배송비</th>
        <th>최종 결제 금액</th>
        <th>요청 시간</th>
        <th>배달 예정</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="order : ${orders}">
        <td th:text="${order.orderId}"></td>
        <td>
          <span th:if="${order.userId} != null">회원</span>
          <span th:if="${order.userId} == null">비회원</span>
        </td>
        <td th:text="${#numbers.formatInteger(order.totalPrice, #numbers.INTEGER_COMMA)} + '원'"></td>
        <td th:text="${#numbers.formatInteger(order.deliveryFee, #numbers.INTEGER_COMMA)} + '원'"></td>
        <td th:text="${#numbers.formatInteger(order.finalPrice, #numbers.INTEGER_COMMA)} + '원'"></td>
        <td th:text="${#dates.format(order.requestedAt, 'yyyy-MM-dd HH:mm')}"></td>
        <td th:text="${#dates.format(order.deliveryAt, 'yyyy-MM-dd')}"></td>
      </tr>
      <tr th:if="${orders.empty}">
        <td colspan="7" class="text-center">등록된 주문이 없습니다.</td>
      </tr>
      </tbody>
    </table>
  </div>

  <hr class="my-5"/>

  <h2 class="mb-4">새 주문 등록</h2>

  <!-- 전역 에러메시지 -->
  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

  <form th:action="@{/orders}" method="post" class="row g-3">

    <!-- 주문 유형 -->
    <div class="col-12">
      <label class="form-label me-3">주문 유형:</label>
      <div class="form-check form-check-inline">
        <input class="form-check-input"
               type="radio"
               th:field="*{orderType}"
               id="typeMember"
               value="member"
               checked
               onchange="toggleGuestFields()">
        <label class="form-check-label" for="typeMember">회원</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input"
               type="radio"
               th:field="*{orderType}"
               id="typeGuest"
               value="guest"
               onchange="toggleGuestFields()">
        <label class="form-check-label" for="typeGuest">비회원</label>
      </div>
      <div class="text-danger small" th:if="${#fields.hasErrors('orderType')}" th:errors="*{orderType}"></div>
    </div>

    <!-- 회원 ID -->
    <div class="col-md-4" id="member-fields">
      <label for="userId" class="form-label">유저 ID</label>
      <input type="number"
             class="form-control"
             th:field="*{userId}"
             id="userId"
             min="1">
      <div class="text-danger small" th:if="${#fields.hasErrors('userId')}" th:errors="*{userId}"></div>
    </div>

    <!-- 비회원 이름 -->
    <div class="col-md-4 d-none" id="guest-fields">
      <label for="guestName" class="form-label">이름</label>
      <input type="text"
             class="form-control"
             th:field="*{guestName}"
             id="guestName">
      <div class="text-danger small" th:if="${#fields.hasErrors('guestName')}" th:errors="*{guestName}"></div>
    </div>

    <!-- 비회원 휴대폰 -->
    <div class="col-md-4 d-none" id="guest-phone-fields">
      <label for="guestPhone" class="form-label">휴대폰</label>
      <input type="tel"
             class="form-control"
             th:field="*{guestPhone}"
             id="guestPhone"
             placeholder="010-1234-5678">
      <div class="text-danger small" th:if="${#fields.hasErrors('guestPhone')}" th:errors="*{guestPhone}"></div>
    </div>

    <!-- 배송일 -->
    <div class="col-md-4">
      <label for="deliveryDate" class="form-label">배송일</label>
      <input type="date"
             class="form-control"
             th:field="*{deliveryDate}"
             id="deliveryDate"
             required>
      <div class="text-danger small" th:if="${#fields.hasErrors('deliveryDate')}" th:errors="*{deliveryDate}"></div>
    </div>

    <!-- 주문 아이템 (단일 행 예시) -->
    <fieldset class="col-12">
      <legend class="col-form-label">아이템</legend>
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <label class="form-label">책 ID</label>
          <input type="number"
                 class="form-control"
                 th:field="*{items[0].bookId}"
                 min="1"
                 required>
          <div class="text-danger small" th:if="${#fields.hasErrors('items[0].bookId')}" th:errors="*{items[0].bookId}"></div>
        </div>
        <div class="col-md-2">
          <label class="form-label">수량</label>
          <input type="number"
                 class="form-control"
                 th:field="*{items[0].quantity}"
                 min="1"
                 value="1"
                 required>
          <div class="text-danger small" th:if="${#fields.hasErrors('items[0].quantity')}" th:errors="*{items[0].quantity}"></div>
        </div>
        <div class="col-md-2 form-check">
          <input class="form-check-input mt-4"
                 type="checkbox"
                 th:field="*{items[0].giftWrapped}">
          <label class="form-check-label mt-4">선물포장</label>
        </div>
        <div class="col-md-3">
          <label class="form-label">포장 옵션 ID</label>
          <input type="number"
                 class="form-control"
                 th:field="*{items[0].wrappingId}">
          <div class="text-danger small" th:if="${#fields.hasErrors('items[0].wrappingId')}" th:errors="*{items[0].wrappingId}"></div>
        </div>
      </div>
    </fieldset>

    <!-- 제출 버튼 -->
    <div class="col-12">
      <button type="submit" class="btn btn-primary">주문 생성</button>
    </div>
  </form>
</div>

<script>
  function toggleGuestFields() {
    const isGuest = document.getElementById('typeGuest').checked;
    document.getElementById('member-fields').classList.toggle('d-none', isGuest);
    document.getElementById('guest-fields').classList.toggle('d-none', !isGuest);
    document.getElementById('guest-phone-fields').classList.toggle('d-none', !isGuest);
  }
</script>
</body>
</html>