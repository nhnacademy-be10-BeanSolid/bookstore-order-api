<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>포인트 충전 테스트</title>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        label { display: block; margin: 8px 0 4px; }
        input { width: 200px; padding: 4px; }
        button { margin-top: 12px; padding: 6px 12px; }
    </style>
</head>
<body>
<h1>결제 요청 테스트 UI</h1>

<label for="payType">payType</label>
<input id="payType" value="CARD" />

<label for="payAmount">payAmount</label>
<input id="payAmount" value="58500" />

<label for="orderName">orderName</label>
<input id="orderName" value="테스트 결제" />

<button id="payBtn">결제 요청</button>

<!-- 토스 SDK는 이 스크립트보다 먼저 로드되어야 합니다 -->
<script src="https://js.tosspayments.com/v1/payment" async></script>
<script>
    const CLIENT_KEY = 'test_ck_DLJOpm5QrlwNvJboZZaNVPNdxbWn';
    const ORIGIN = window.location.origin; // e.g. http://localhost:10350

    document.getElementById('payBtn').addEventListener('click', async () => {
        const payType   = document.getElementById('payType').value;
        const amount    = Number(document.getElementById('payAmount').value);
        const orderName = document.getElementById('orderName').value;

        try {
            // 1) 절대경로로 fetch 호출
            const resp = await fetch(`${ORIGIN}/api/v1/payments/toss`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payType, payAmount: amount, orderName })
            });
            console.log('HTTP status:', resp.status);

            // 2) 에러 처리
            if (!resp.ok) {
                const err = await resp.json().catch(() => null);
                throw new Error(err?.message || resp.statusText);
            }

            // 3) 응답 JSON
            const data = await resp.json();
            console.log('백엔드 응답:', data);

            // 4) 콜백 URL 보정 (서버 yml에 버전이 빠졌거나 잘못됐을 때 대비)
            const successUrl = data.successUrl
                ?? `${ORIGIN}/api/v1/payments/toss/success`;
            const failUrl = data.failUrl
                ?? `${ORIGIN}/api/v1/payments/toss/fail`;

            // 5) 토스 SDK로 결제창 호출
            const toss = TossPayments(CLIENT_KEY);
            toss.requestPayment(data.payType, {
                amount:        data.payAmount,
                orderId:       data.orderId,
                orderName:     data.orderName,
                customerName:  '홍길동',
                customerEmail: 'hong@domain.com',
                successUrl,
                failUrl
            }).catch(e => {
                console.error('결제창 호출 에러:', e.code, e.message);
            });

        } catch (e) {
            console.error('결제 준비 중 에러:', e);
            alert('결제 요청에 실패했습니다:\n' + e.message);
        }
    });
</script>
</body>
</html>