<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>결제 완료</title>
    <style>
        body { font-family: sans-serif; margin: 40px; text-align: center; }
        .response-section { margin: 20px 0; text-align: left; display: inline-block; }
        .response-label { font-weight: bold; }
        .response-text { margin-left: 8px; }
        #confirm-success { display: none; }   /* 숨겨두기 */
        #loading { font-size: 1.2em; }
        #cancelBtn { margin-top: 16px; padding: 8px 16px; }
    </style>
</head>
<body>
<!-- 1) 로딩 화면 -->
<div id="loading">
    <img src="https://static.toss.im/lotties/loading-spot-apng.png" width="60" height="60" alt="로딩" />
    <p>결제 처리 중입니다… 잠시만 기다려주세요.</p>
</div>

<!-- 2) 10초 후에 보여줄 성공 화면 -->
<div id="confirm-success">
    <img src="https://static.toss.im/illusts/check-blue-spot-ending-frame.png" width="120" height="120" alt="성공" />
    <h2>결제를 완료했어요</h2>
    <div class="response-section">
        <div>
            <span class="response-label">결제 금액:</span>
            <span id="amount" class="response-text"></span>
        </div>
        <div>
            <span class="response-label">주문번호:</span>
            <span id="orderId" class="response-text"></span>
        </div>
        <div>
            <span class="response-label">paymentKey:</span>
            <span id="paymentKey" class="response-text"></span>
        </div>
    </div>
    <!-- 결제 취소 버튼 추가 -->
    <button id="cancelBtn">결제 취소하기</button>
</div>

<script>
    // URL 파라미터 읽어오기
    const params     = new URLSearchParams(window.location.search);
    const paymentKey = params.get('paymentKey') || '';
    const orderId    = params.get('orderId')    || '';
    const amount     = params.get('amount')     || '';

    // 10초 대기 후에 성공 화면으로 전환
    setTimeout(() => {
        // 로딩 숨기고, 성공 화면 보이기
        document.getElementById('loading').style.display = 'none';
        const successDiv = document.getElementById('confirm-success');
        successDiv.style.display = 'block';

        // 성공 정보 채우기
        document.getElementById('paymentKey').textContent = paymentKey;
        document.getElementById('orderId').textContent    = orderId;
        document.getElementById('amount').textContent     = amount;

        // 부모 창에 성공 메시지 보내기
        window.opener?.postMessage(
            { type: 'toss:success', paymentKey, orderId, amount },
            '*'
        );

        // 결제 취소 버튼 핸들러 등록
        document.getElementById('cancelBtn').addEventListener('click', () => {
            fetch(
                `/api/v1/payments/toss/cancel/point`
                + `?paymentKey=${encodeURIComponent(paymentKey)}`
                + `&cancelReason=${encodeURIComponent('맘에 안듬')}`,
                {
                    method: 'GET',
                    credentials: 'include'   // 로그인 세션(쿠키)을 함께 보내려면 필요
                }
            )
                .then(res => {
                    if (!res.ok) throw new Error(res.statusText);
                    return res.json();
                })
                .then(json => {
                    alert('환불 요청 성공:\n' + JSON.stringify(json, null, 2));
                })
                .catch(err => {
                    console.error(err);
                    alert('환불 요청 중 오류가 발생했습니다.');
                });
        });

    }, 10_000); // 10,000ms = 10초
</script>
</body>
</html>