<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ê²°ì œ ì™„ë£Œ</title>
    <style>
        body { font-family: sans-serif; margin: 40px; text-align: center; }
        .response-section { margin: 20px 0; display: inline-block; text-align: left; }
        .response-label { font-weight: bold; display: inline-block; width: 100px; }
        .response-text  { margin-left: 8px; }
        button { margin: 8px; padding: 8px 16px; }
        #error { color: red; margin-top: 20px; }
    </style>
</head>
<body>

<div id="loading">
    <p>ê²°ì œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
</div>

<div id="confirm-success" style="display:none;">
    <h2>ê²°ì œë¥¼ ì™„ë£Œí–ˆì–´ìš” ğŸ‰</h2>
    <div class="response-section">
        <div><span class="response-label">ê²°ì œê¸ˆì•¡:</span><span id="amount"      class="response-text">-</span> ì›</div>
        <div><span class="response-label">ì£¼ë¬¸ë²ˆí˜¸:</span><span id="orderId"     class="response-text">-</span></div>
        <div><span class="response-label">ê²°ì œí‚¤:</span><span id="paymentKey"  class="response-text">-</span></div>
        <div><span class="response-label">ê²°ì œID:</span><span id="paymentId"   class="response-text">-</span></div>
    </div>
    <button id="cancelBtn">í™˜ë¶ˆí•˜ê¸°</button>
    <button id="closeBtn">ë‹«ê¸°</button>
    <div id="cancelResult" style="margin-top:12px;"></div>
</div>

<div id="error" style="display:none;"></div>

<script>
    (function() {
        const params    = new URLSearchParams(window.location.search);
        const paymentKey= params.get('paymentKey')   || params.get('payment_key');
        const orderId   = params.get('orderId')      || params.get('order_id');
        const amount    = params.get('amount')       || params.get('payAmount');
        const paymentId = params.get('paymentId')    || params.get('payment_id');

        if (!paymentKey || !orderId || !amount) {
            document.getElementById('loading').style.display = 'none';
            const err = document.getElementById('error');
            err.textContent = 'ê²°ì œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            err.style.display = 'block';
            return;
        }

        setTimeout(() => {
            document.getElementById('loading').style.display        = 'none';
            document.getElementById('confirm-success').style.display= 'block';
            document.getElementById('paymentKey').textContent       = paymentKey;
            document.getElementById('orderId').textContent          = orderId;
            document.getElementById('amount').textContent           = amount;
            document.getElementById('paymentId').textContent        = paymentId || '-';

            document.getElementById('cancelBtn').addEventListener('click', () => {
                const resultEl = document.getElementById('cancelResult');
                resultEl.textContent = 'í™˜ë¶ˆ ìš”ì²­ ì¤‘â€¦';
                fetch(
                    `${window.location.origin}/api/v1/payments/toss/cancel/point`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ paymentKey, cancelReason: 'ì‚¬ìš©ì ìš”ì²­' })
                    }
                )
                    .then(res => res.ok ? res.json() : Promise.reject(res.status))
                    .then(json => resultEl.textContent = 'í™˜ë¶ˆ ì„±ê³µ: ' + JSON.stringify(json))
                    .catch(err => {
                        resultEl.innerHTML = 'í™˜ë¶ˆ ì‹¤íŒ¨: ' + err + '<br/><button id="retry">ë‹¤ì‹œ ì‹œë„</button>';
                        document.getElementById('retry').addEventListener('click', () => resultEl.textContent = '');
                    });
            });

            document.getElementById('closeBtn').addEventListener('click', () => window.close());
        }, 2000);
    })();
</script>
</body>
</html>