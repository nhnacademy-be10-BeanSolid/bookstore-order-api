<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>결제 완료</title>
    <style>
        body { font-family: sans-serif; margin: 40px; text-align: center; }
        .response-section { margin: 20px 0; text-align: left; display: inline-block; }
        .response-label { font-weight: bold; }
        .response-text { margin-left: 8px; }
        #confirm-success { display: none; }
        #loading { font-size: 1.2em; }
        button { margin-top: 16px; padding: 8px 16px; }
        #error { color: red; }
    </style>
</head>
<body>

<div id="loading">
    <img src="https://static.toss.im/lotties/loading-spot-apng.png" width="60" height="60" alt="로딩" />
    <p>결제 처리 중입니다… 잠시만 기다려주세요.</p>
</div>

<div id="confirm-success">
    <img src="https://static.toss.im/illusts/check-blue-spot-ending-frame.png"
         width="120" height="120" alt="성공" />
    <h2>결제를 완료했어요</h2>
    <div class="response-section">
        <div>
            <span class="response-label">결제 금액:</span>
            <span id="amount" class="response-text"></span> 원
        </div>
        <div>
            <span class="response-label">주문번호:</span>
            <span id="orderId" class="response-text"></span>
        </div>
        <div>
            <span class="response-label">paymentKey:</span>
            <span id="paymentKey" class="response-text"></span>
        </div>
    </div>
    <button id="cancelBtn">결제 취소하기</button>
    <button id="closeBtn">창 닫기</button>
    <div id="cancelResult" style="margin-top:12px;"></div>
</div>

<div id="error" style="display:none;"></div>

<script>
    (function() {
        const origin      = window.location.origin;
        const params      = new URLSearchParams(window.location.search);
        const paymentKey  = params.get('paymentKey');
        const orderId     = params.get('orderId');
        const amount      = params.get('amount');

        if (!paymentKey || !orderId || !amount) {
            document.getElementById('loading').style.display = 'none';
            const err = document.getElementById('error');
            err.textContent = '결제 정보가 올바르게 전달되지 않았습니다.';
            err.style.display = 'block';
            return;
        }

        // 10초 후에 성공 화면으로 전환
        setTimeout(() => {
            document.getElementById('loading').style.display        = 'none';
            const successDiv = document.getElementById('confirm-success');
            successDiv.style.display                                = 'block';

            document.getElementById('paymentKey').textContent       = paymentKey;
            document.getElementById('orderId').textContent          = orderId;
            document.getElementById('amount').textContent           = amount;

            // 부모창에 메시지 전송 (origin 검사 포함)
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage(
                        { type: 'toss:success', paymentKey, orderId, amount },
                        origin
                    );
                } catch (e) {
                    console.warn('부모창 전송 실패', e);
                }
            }

            const cancelBtn = document.getElementById('cancelBtn');
            const closeBtn  = document.getElementById('closeBtn');
            const resultEl  = document.getElementById('cancelResult');

            cancelBtn.addEventListener('click', () => {
                cancelBtn.disabled = true;
                resultEl.textContent = '환불 요청 중…';

                const body = new URLSearchParams();
                body.append('paymentKey', paymentKey);
                body.append('cancelReason', '사용자 요청');

                fetch(
                    `${origin}/api/v1/payments/toss/cancel/point`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: body.toString(),
                        credentials: 'include',
                        mode: 'cors'
                    }
                )
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return res.json();
                    })
                    .then(json => {
                        resultEl.textContent = '환불 성공: ' + JSON.stringify(json);
                    })
                    .catch(err => {
                        console.error(err);
                        resultEl.innerHTML = '환불 실패: ' + err.message +
                            '<br/><button id="retry">다시 시도</button>';
                        document.getElementById('retry').addEventListener('click', () => {
                            cancelBtn.disabled = false;
                            resultEl.textContent = '';
                        });
                    });
            });

            closeBtn.addEventListener('click', () => window.close());
        }, 10000);
    })();
</script>
</body>
</html>